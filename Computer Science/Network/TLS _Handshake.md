# TLS(Transport Layer Security) Handshake

클라이언트와 서버 간에 **안전한 통신**을 설정하기 위한 절차

클라이언트와 서버가 서로 인증하고, 암호화 키를 교환한 후 안전한 연결을 설정하는 일련의 단계로 이루어짐

- 4가지 핵심 목표
1. **암호화 알고리즘 협상 (암호 스위트 결정)**
    
    → 클라이언트(브라우저)와 서버가 서로 어떤 언어(암호화 방식)로 대화할지를 결정
    
2. **서버 인증 (인증서 확인)**
    
    → 클라이언트가 접속하려는 서버가 해커가 아닌 신뢰할 수 있는 진짜 서버인지 검증
    
3. **세션 키 생성 (대칭키 생성)**
    
    → 데이터 전송 속도와 보안성을 모두 잡기 위해 실제 데이터 암호화에 사용할 대칭키를 생성하는 단계
    
4. **데이터 암호화 시작 (보안 채널 생성)**
    
    → 모든 준비가 끝났음을 알리고, 협상된 알고리즘과 생성된 세션 키로 암호화 통신을 시작하는 단계
    

---

## TLS Handshake 과정 (1.2)

### **1. ClientHello**

- **목적:** 클라이언트가 서버에 연결을 요청하고, 통신에 사용할 보안 옵션 후보들을 제안
    - **TLS 버전:** 클라이언트가 지원하는 최상위 TLS 버전
    - **암호 스위트 목록:** 지원 가능한 암호화 알고리즘 목록 (우선순위 순으로 나열)
    - **랜덤 데이터 (Client Random):** 나중에 세션 키를 생성할 때 사용할 32바이트 난수
    - **세션 ID:** 기존 연결을 재사용하여 과정을 단축하고 싶을 때 보냄 (없으면 0)

→ 브라우저가 이 메시지를 보내면, 서버는 이 정보를 토대로 보안 설정을 결정

### **2. ServerHello 및 인증 (Server Actions)**

- **목적:** 클라이언트가 제시한 옵션 중 하나를 선택하고, 서버의 인증서(신분증)를 전달
- **ServerHello 메시지:**
    - **선택된 TLS 버전:** 클라이언트가 지원하는 버전 중 가장 높은 버전 확정
    - **선택된 암호 스위트:** 클라이언트 목록 중 서버가 선택한 하나의 알고리즘 (예: `TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256`)
    - **Server Random:** 서버가 생성한 난수 (세션 키 생성용)
    - **Session ID:** 세션을 생성하거나 기존 세션을 재개함을 알림
- **Certificate (인증서):** 서버의 공개키(Public Key)가 포함된 SSL/TLS 인증서 전송
- **Server Key Exchange (선택적):**
    - **목적:** 인증서 내의 공개키만으로 키 교환이 불가능한 경우(예: Diffie-Hellman 방식 사용 시) 추가 파라미터를 전송
    - *최근 보안 권장 사항인 PFS(완전한 순방향 기밀성)를 적용할 때 이 단계가 중요하게 사용됨*
- **Server Hello Done:** "서버가 보낼 정보는 다 보냈다"는 신호

### **3. 클라이언트 키 교환 및 검증 (Client Actions)**

- **목적:** 서버 인증서 검증 후, 'Pre-Master Secret'을 공유하여 양쪽이 동일한 세션 키를 생성하도록 함
- **인증서 검증 (내부 절차):** CA(인증 기관)의 서명을 확인하여 서버가 신뢰할 수 있는지 판단
- **Client Key Exchange:**
    - **내용:** **Pre-Master Secret**(예비 마스터 비밀)이라는 임시 키 값을 생성하여 전송
    - **암호화:** 이 값은 네트워크 상에서 탈취되지 않도록 **서버의 공개키**로 암호화하여 보냄 (서버만 개인키로 복호화 가능)
    - *참고:* Diffie-Hellman 방식 사용 시에는 키 자체가 아닌 키 생성을 위한 파라미터를 교환
- **Change Cipher Spec:** "지금부터 보내는 메시지는 협상된 알고리즘과 세션 키로 암호화하겠다"는 알림
- **Finished:**
    - **내용:** 지금까지 주고받은 핸드셰이크 메시지들의 해시(Hash) 값을 세션 키로 암호화하여 전송
    - **목적:** 서버가 이 값을 복호화하여 대조해봄으로써, 중간에 위변조가 없었는지 확인

### **4. 서버 마무리 (Server Finish)**

- **목적:** 클라이언트가 보낸 정보를 바탕으로 세션 키를 완성하고, 보안 연결 수립을 최종 확인
- **Change Cipher Spec:** "나(서버)도 이제부터 세션 키로 암호화해서 보내겠다"는 알림
- **Finished:**
    - 서버 입장에서 핸드셰이크 전체 메시지의 해시 값을 암호화하여 전송
    - 클라이언트가 이를 확인하여 최종적으로 연결 신뢰성 검증

### **5. 최종: Secure Channel (Application Data)**

- HTTP 프로토콜 등의 실제 데이터가 전송
- 모든 데이터는 앞서 만든 세션 키(대칭키)로 암호화되어 오고 감

---

## TLS Handshake 과정 (1.3)

### 1. ClientHello (Key Share 포함)

- **목적:** 연결 요청과 동시에 **'키 교환 재료'를 미리 보내서** 시간을 단축함 (예측)
- **TLS 버전:** 1.3 지정
- **암호 스위트 목록:** 지원 가능한 암호화 알고리즘 목록
- **랜덤 데이터 (Client Random):** 나중에 키 생성에 사용할 난수
- **Key Share (핵심):**
    - 클라이언트가 서버가 사용할 법한 키 교환 알고리즘(예: ECDHE)을 예측하여, 미리 생성한 **자신의 키 재료(공개값)**를 포함해서 보냄
    

### 2. ServerHello 및 암호화된 핸드셰이크 (Server Actions)

- **목적:** 키 교환을 즉시 완료하고, **인증서와 서명을 '암호화'해서 전달**
- **ServerHello 메시지:**
    - **선택된 암호 스위트:** 클라이언트 목록 중 하나 확정
    - **Server Random:** 서버가 생성한 난수
    - **Key Share:** 서버 측의 **키 재료** 전달
    - → *이 시점에서 양쪽 다 재료를 가졌으므로 즉시 **세션 키(암호화 키) 계산 완료***
- **(여기서부터 모든 메시지는 위에서 만든 키로 암호화됨)**
- **Encrypted Extensions:** 기타 서버 설정 정보 (암호화됨)
- **Certificate (인증서):** 서버의 공개키가 포함된 인증서 (**암호화**됨)
- **Certificate Verify (전자서명):**
    - **목적:** "내가 보낸 Key Share는 진짜 내가 보낸 거야"라고 **개인키로 서명(도장)**
    - 핸드셰이크 전체 내용을 해시한 뒤, 개인키로 서명해서 보냄
- **Finished:** 핸드셰이크 무결성 검증

### 3. 클라이언트 검증 및 마무리 (Client Actions)

- **목적:** 서버의 서명을 확인하여 신뢰성을 검증하고, 연결 수립을 확정
- **인증서 및 서명 검증:**
    - 암호화된 패킷을 세션 키로 풀어서 인증서를 확인
    - 인증서 안의 **공개키**로 `Certificate Verify`의 **서명을 확인(검증)**
- **Finished:**
    - 클라이언트도 핸드셰이크 전체 내용을 해시하여 전송
    - 서버가 이를 확인하여 최종 연결 확정

### 4. 최종: Secure Channel (Application Data)

- HTTP 등 실제 데이터 전송 (1.2와 동일)
- 이미 만들어진 세션 키(대칭키)로 암호화하여 통신

---

## TLS 1.2 vs TLS 1.3

- **속도 향상 (RTT 감소):**
    - **TLS 1.2:** 연결 설정에 **2-RTT**(Round Trip Time, 왕복 2회)가 필요
    - **TLS 1.3:** 불필요한 절차를 과감히 줄여 **1-RTT**(왕복 1회)만으로 연결이 가능하며, 0-RTT(이전 연결 재사용 시)도 지원하여 훨씬 빠름
        
        → **인사 + 키 교환 동시에 진행**
        
- **보안 강화:**
    - 보안에 취약한 암호화 알고리즘(구형 키 교환 방식 등)을 제거
    - **Server Hello 이후의 모든 메시지를 암호화**하여 핸드셰이크 과정 자체의 정보 노출을 최소화

| **비교 항목** | **TLS 1.2 (기존)** | **TLS 1.3 (최신 표준)** | **핵심 차이 (Why?)** |
| --- | --- | --- | --- |
| **핸드셰이크 속도** | **2-RTT** (왕복 2회) | **1-RTT** (왕복 1회) | 불필요한 절차를 생략하여 **연결 속도가 2배** 빨라짐 (0-RTT 재접속도 가능) |
| **키 교환 방식** | RSA, DH 등 다양함(정적 키 교환 허용) | **(EC)DHE 전용**(정적 RSA 폐지) | 탈취 위험이 있는 RSA 키 교환을 없애고, **PFS(완전 순방향 기밀성)**를 강제함 |
| **암호 스위트** | 매우 복잡하고 많음(30개 이상) | **간소화됨**(5개 내외) | 취약한 구형 알고리즘을 제거하여 **보안 구멍을 원천 차단** |
| **보안 범위** | 핸드셰이크 대부분이 평문(암호화 X)으로 전송 | **Server Hello 이후** **대부분 암호화** | 인증서 등 민감한 정보가 네트워크에 노출되는 것을 방지 |